<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>PestAlert</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800 p-6 max-w-xl mx-auto font-yekan">
  <h1 class="text-3xl font-bold mb-6 text-center">PestAlert - کشاورزی هوشمند</h1>

  <section class="mb-8 bg-white p-4 rounded shadow">
    <h2 class="text-xl font-semibold mb-4">ثبت مزرعه جدید</h2>
    <form id="farmForm" class="space-y-4">
      <input id="name" type="text" placeholder="نام مزرعه" required
        class="w-full p-2 border rounded" />
      <input id="latitude" type="number" step="0.0001" placeholder="عرض جغرافیایی" required
        class="w-full p-2 border rounded" />
      <input id="longitude" type="number" step="0.0001" placeholder="طول جغرافیایی" required
        class="w-full p-2 border rounded" />
      <button type="submit" class="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700">ثبت مزرعه</button>
    </form>
  </section>

  <section class="mb-8 bg-white p-4 rounded shadow">
    <h2 class="text-xl font-semibold mb-4">مزارع ثبت شده</h2>
    <ul id="farmList" class="list-disc list-inside space-y-2"></ul>
  </section>

  <section class="mb-8 bg-white p-4 rounded shadow">
    <h2 class="text-xl font-semibold mb-4">هشدارهای اخیر</h2>
    <ul id="alertList" class="list-disc list-inside space-y-2"></ul>
  </section>

  <button id="runChecksBtn" class="w-full bg-green-600 text-white p-3 rounded hover:bg-green-700 mb-8">
    اجرای بررسی آفات
  </button>

  <script>
    const apiBase = 'YOUR_NGROK_OR_RENDER_URL';  // اینجا آدرس public APIت رو بذار
    const internalToken = 'my-secret-token';    // این توکن باید با توکن توی backend یکی باشه

    async function fetchFarms() {
      try {
        const res = await fetch(`${apiBase}/farms/`);
        const farms = await res.json();
        const farmList = document.getElementById('farmList');
        farmList.innerHTML = '';
        farms.forEach(farm => {
          const li = document.createElement('li');
          li.textContent = `${farm.name} (عرض: ${farm.latitude.toFixed(4)}, طول: ${farm.longitude.toFixed(4)})`;
          farmList.appendChild(li);
        });
      } catch (err) {
        alert("خطا در دریافت مزارع.");
      }
    }

    async function fetchAlerts() {
      try {
        const res = await fetch(`${apiBase}/alerts/`);
        const alerts = await res.json();
        const alertList = document.getElementById('alertList');
        alertList.innerHTML = '';
        alerts.forEach(alert => {
          const li = document.createElement('li');
          const date = new Date(alert.timestamp);
          li.textContent = `[${date.toLocaleString()}] ${alert.message}`;
          alertList.appendChild(li);
        });
      } catch (err) {
        alert("خطا در دریافت هشدارها.");
      }
    }

    document.getElementById('farmForm').addEventListener('submit', async e => {
      e.preventDefault();
      const name = document.getElementById('name').value.trim();
      const latitude = parseFloat(document.getElementById('latitude').value);
      const longitude = parseFloat(document.getElementById('longitude').value);

      if (!name || isNaN(latitude) || isNaN(longitude)) {
        alert("لطفاً همه فیلدها را درست پر کنید.");
        return;
      }

      try {
        const res = await fetch(`${apiBase}/farms/`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({name, latitude, longitude})
        });
        if (res.ok) {
          alert("مزرعه با موفقیت ثبت شد!");
          fetchFarms();
          e.target.reset();
        } else {
          alert("خطا در ثبت مزرعه.");
        }
      } catch (err) {
        alert("خطا در ثبت مزرعه.");
      }
    });

    document.getElementById('runChecksBtn').addEventListener('click', async () => {
      try {
        const res = await fetch(`${apiBase}/internal/run-checks?token=${internalToken}`, {
          method: 'POST'
        });
        if (res.ok) {
          alert("بررسی آفات با موفقیت اجرا شد!");
          fetchAlerts();
        } else {
          alert("خطا در اجرای بررسی آفات.");
        }
      } catch (err) {
        alert("خطا در اجرای بررسی آفات.");
      }
    });

    // بارگذاری اولیه داده‌ها
    fetchFarms();
    fetchAlerts();
  </script>
</body>
</html>
